version: "3.9"
services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: gis_qdrant
    ports:
      - "6333:6333"
    volumes:
      - ./docker_mount/qdrant:/qdrant/storage

  retrieval_gpu:
    build:
      context: .
      dockerfile: docker/retrieval.Dockerfile
    image: gis/retrieval:cu124
    container_name: gis_retrieval_gpu
    privileged: true
    gpus: all
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - HF_HOME=/model_cache
      - TRANSFORMERS_CACHE=/model_cache
    volumes:
      - ./docker_mount/project:/project
      - ./docker_mount/project/code/retrieval:/app/retrieval
      - ./docker_mount/project/models:/model_cache
    working_dir: /app/retrieval
    command: sleep infinity
    depends_on:
      - qdrant
