from http.server import BaseHTTPRequestHandler, HTTPServer
import json, os, uuid
from io import BytesIO

# minimal Pillow without install? -> use pure PNG writer fallback if PIL missing
try:
    from PIL import Image, ImageDraw, ImageFont
    HAVE_PIL = True
except Exception:
    HAVE_PIL = False

ROOT = "/project/results"

def ensure_dir(p):
    os.makedirs(p, exist_ok=True)

def make_png(path, text="overlay", size=(512,512)):
    ensure_dir(os.path.dirname(path))
    if HAVE_PIL:
        img = Image.new("RGBA", size, (255,0,0,90))  # translucent red
        d = ImageDraw.Draw(img)
        d.rectangle([10,10,size[0]-10,size[1]-10], outline=(0,0,0,255), width=3)
        d.text((20,20), text, fill=(0,0,0,255))
        img.save(path, format="PNG")
    else:
        # Tiny 1x1 PNG pixel as fallback
        raw = bytes.fromhex(
            "89504E470D0A1A0A0000000D49484452000000010000000108060000001F15C489"
            "0000000A49444154789C6360000002000150A0B56B0000000049454E44AE426082"
        )
        with open(path, "wb") as f: f.write(raw)

class H(BaseHTTPRequestHandler):
    def _send(self, code=200, ctype="text/plain"):
        self.send_response(code); self.send_header("Content-Type", ctype); self.end_headers()
    def do_GET(self):
        if self.path == "/infer/api":
            self._send(); self.wfile.write(b"hello world"); return
        self._send(); self.wfile.write(b"ok")
    def do_POST(self):
        if self.path != "/infer/api":
            self._send(404); self.wfile.write(b"not found"); return
        n = int(self.headers.get("Content-Length","0") or 0)
        body = self.rfile.read(n) if n>0 else b"{}"
        try:
            req = json.loads(body.decode("utf-8") or "{}")
        except Exception:
            req = {}
        # create a unique overlay image
        uid = str(uuid.uuid4())
        out_dir = os.path.join(ROOT, uid)
        out_path = os.path.join(out_dir, "overlay.png")
        title = f"hello world | bbox={req.get('bbox')}"
        make_png(out_path, text=title)
        resp = {"text":"hello world","echo":req,"image_url":f"/results/{uid}/overlay.png"}
        self._send(200,"application/json"); self.wfile.write(json.dumps(resp).encode("utf-8"))

if __name__ == "__main__":
    HTTPServer(("", 8081), H).serve_forever()
